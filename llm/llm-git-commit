#!/bin/bash
# llm-git-commit: git commit with a message generated by ChatGPT or Claude

model_code=""

usage() {
	echo "Usage: llm-git-commit [-3|-4|-c|-i] [-m message] [-e] [-h]"
	echo "  -3: generate with ChatGPT-3.5"
	echo "  -4: generate with GPT-4"
	echo "  -c: generate with Claude"
	echo "  -C: generate with Claude 100k"
	echo "  -i: generate with Claude Instant"
	echo "  -I: generate with Claude Instant 100k"
	echo "  -m: use the given message instead of generating one"
	echo "  -e: normal git commit using the editor"
	echo "  -h: show this help message"
}

while getopts "34cCiIm:eh" opt; do
	case "$opt" in
	3 ) model="3+";;
	4 ) model="4";;
	c ) model="c";;
	C ) model="c+";;
	i ) model="i";;
	I ) model="i+";;
	e ) exec git commit ;;
	m ) exec git commit -m "$OPTARG" ;;
	h ) usage; exit 0;;
	* ) usage; exit 1;;
	esac
done
shift $((OPTIND-1))

cleanup() {
	f -type f -name 'commit-message.*.txt' -size 0 -- | xa rm
}

trap 'cleanup; exit' EXIT
trap 'cleanup; exit 1' INT

timestamp=`date +%Y%m%d%H%M%S`
commit_message="commit-message.$timestamp.txt"
review="review.$timestamp.txt"

model-name() {
	model="$1"
	case "$model" in
	3+ ) echo "ChatGPT-3.5";;
	4 ) echo "GPT-4";;
	c ) echo "Claude";;
	c+ ) echo "Claude 100k";;
	i ) echo "Claude Instant";;
	i+ ) echo "Claude Instant 100k";;
	esac
}

generate-commit-message() {
	model="$1"
	echo "Generating commit message using `model-name $model` ..."
	if [ -e "$commit_message" ]; then
		echo >&2 "Commit message already exists: $commit_message, moving it to rubbish."
		mr "$commit_message"
	fi
	git diff --staged |
		llm process -m $model 'Please describe this diff, for a git commit message, following the Conventional Commits spec.
Do not invent anything that is not in the diff!
Only describe the actual changes, lines starting with + and -, not the surrounding context.
The required format is as follows:

feat|fix(short-module-name): a short summary line, preferably around 50 chars, not more than 70 chars

- concise info about first change, if needed. DO NOT WRAP THE LINES
- concise info about second change, if any. DO NOT WRAP THE LINES
- and so on ...

There can be only one feat or fix line per commit, then a blank line, then there can be multiple list items starting with -, DO NOT WRAP THE LINES.
The (short-module-name) part is optional. Commit type can be feat|fix|chore etc.
' |
	fmt -s -w 78 -g 78 > "$commit_message"
}

check-for-bugs() {
	model="$1"
	echo "Checking for bugs using `model-name $model` ..."
	if [ -e "$review" ]; then
		echo >&2 "Code review already exists: $review, moving it to rubbish."
		mr "$review"
	fi
	git diff --staged |
		llm process -m $model 'Please do a code review: check this diff carefully for bugs, and tell me in brief about any bugs, other issues, or suggestions to improve it.' |
		fmt -s -w 78 -g 78 |
		tee "$review"
}

if [ -n "$model" ]; then
	generate-commit-message "$model"
fi

cleanup-and-exit() {
	if type move-rubbish >/dev/null 2>&1; then
		move-rubbish "$commit_message" "$review" 2>/dev/null
	else
		rm -f "$commit_message" "$review"
	fi
	exit "$1"
}

while true; do
	if [ -e "$commit_message" ]; then
		cat "$commit_message"
		echo
		prompt="Commit with this message?"
	else
		prompt="Action?"
	fi
	read -p "$prompt [y/n/e/3/4/c/C/i/I/d/v/b/?] " -n 1 -r choice 2>&1
	echo
	case "$choice" in
		y|Y) break;;
		n|N|q|Q)
			cleanup-and-exit 1
			;;
		e|E)
			${EDITOR:-vi} "$commit_message"
			;;
		3)
			generate-commit-message 3+
			;;
		4)
			generate-commit-message 4
			;;
		c)
			generate-commit-message c
			;;
		C)
			generate-commit-message c+
			;;
		i)
			generate-commit-message i
			;;
		I)
			generate-commit-message i
			;;
		d|D)
			git diff --staged
			;;
		v|V)
			git-vimdiff-staged
			;;
		b|B)
			check-for-bugs 4
			;;
		\?|h)
			echo "y: commit with this message"
			echo "n: abort"
			echo "e: edit the message"
			echo "3: generate with ChatGPT-3.5"
			echo "4: generate with GPT-4"
			echo "c: generate with Claude"
			echo "C: generate with Claude 100k"
			echo "i: generate with Cluade Instant"
			echo "d: diff the staged changes"
			echo "v: vimdiff the staged changes"
			echo "b: check for bugs with GPT-4"
			echo "?: show this help message"
			echo
			;;
		*)
			echo "Invalid choice"
			;;
	esac
done

git commit -F "$commit_message"
cleanup-and-exit "$?"
