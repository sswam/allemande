#!/bin/bash
# gpt-git-commit: git commit with a message generated by gpt

file="commit-message.`date +%Y%m%d%H%M%S`.txt"

generate-commit-message() {
	model="$1"
	git diff --staged |
		gpt process -m $model 'Please describe this diff, for a git commit message, format as follows:
a very short summary line, preferably around 50 chars, and strictly not more than 70 chars

- concise info about first change, not more than 78 chars per line
- concise info about second change, not more than 78 chars per line
- and so on
' |
	fmt -s -w 78 -g 78 > "$file"
}

generate-commit-message 3+

# confirm, y / n or e to edit

while true; do
	cat "$file"
	echo
	read -p "Commit with this message? [y/n/e/4] " -n 1 -r choice 2>&1
	echo
	case "$choice" in
		y|Y ) break;;
		n|N ) exit 1;;
		e|E ) ${EDITOR:-vi} "$file";;
		4 ) generate-commit-message 4;;  # use GPT-4
		* ) echo "Invalid choice";;
	esac
done

git commit -F "$file" &&
	rm "$file"
