#!/bin/bash
# gpt-git-commit: git commit with a message generated by gpt

model="${1:-3+}"

file="commit-message.`date +%Y%m%d%H%M%S`.txt"

generate-commit-message() {
	model="$1"
	echo "Generating commit message using GPT-$model ..."
	git diff --staged |
		gpt process -m $model 'Please describe this diff, for a git commit message, format as follows:
a very short summary line, preferably around 50 chars, and strictly not more than 70 chars

- concise info about first change, not more than 78 chars per line
- concise info about second change, not more than 78 chars per line
- and so on
' |
	fmt -s -w 78 -g 78 > "$file"
}

generate-commit-message "$model"

# confirm, y / n or e to edit

while true; do
	cat "$file"
	echo
	read -p "Commit with this message? [y/n/e/3/4/?] " -n 1 -r choice 2>&1
	echo
	case "$choice" in
		y|Y ) break;;
		n|N|q|Q ) exit 1;;
		e|E ) ${EDITOR:-vi} "$file";;
		3 ) generate-commit-message 3+;;
		4 ) generate-commit-message 4;;
		\?|h ) echo "y: commit with this message"
			echo "n: abort"
			echo "e: edit the message"
			echo "3: generate with ChatGPT-3.5"
			echo "4: generate with GPT-4";;
		* ) echo "Invalid choice";;
	esac
done

git commit -F "$file" &&
	rm "$file"
