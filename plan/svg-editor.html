<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple SVG Graph Editor</title>

<style>
* {
	box-sizing: border-box;
}
body, html {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0;
    overflow: hidden;
}
svg {
/*    border: 1px solid red; */
}
foreignObject > div {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-family: sans-serif;
    font-size: 8px;
    white-space: pre-wrap;
    word-wrap: break-word;
    outline: none;
}
</style>

</head>

<body>

    <svg width="100px" height="100px">
        <path id="arc" class="arc" data-from="node1" data-to="node2" d="" stroke="black" fill="none" />
        <g id="node1" class="draggable" transform="translate(100,100)">
            <circle cx="0" cy="0" r="30" fill="lightblue"></circle>
            <foreignObject x="-25" y="-15" width="50" height="30">
                <div xmlns="http://www.w3.org/1999/xhtml" contenteditable="true">Node 1</div>
            </foreignObject>
        </g>
        <g id="node2" class="draggable" transform="translate(300,300)">
            <circle cx="0" cy="0" r="30" fill="lightgreen"></circle>
            <text x="0" y="5" text-anchor="middle" font-size="16" fill="black">Node 2</text>
        </g>
    </svg>

<script>
const svg = document.querySelector("svg");
const arc = document.getElementById("arc");

let selectedElement, offset, transform;

function updateArc(arcElement) {
    const fromNode = document.querySelector(`#${arcElement.dataset.from}`);
    const toNode = document.querySelector(`#${arcElement.dataset.to}`);
    const transform1 = node1.transform.baseVal.getItem(0);
    const transform2 = node2.transform.baseVal.getItem(0);

    const x1 = transform1.matrix.e;
    const y1 = transform1.matrix.f;
    const x2 = transform2.matrix.e;
    const y2 = transform2.matrix.f;

    const fraction = +0.2; // Change this value to adjust the control point's position

    // Calculate the midpoint between the nodes
    const midpointX = (x1 + x2) / 2;
    const midpointY = (y1 + y2) / 2;

    // Calculate the vector between the nodes
    const vectorX = x2 - x1;
    const vectorY = y2 - y1;

    // Calculate the length of the vector
    const length = Math.sqrt(vectorX * vectorX + vectorY * vectorY);

    // Calculate the normalized perpendicular vector
    const perpendicularX = -vectorY / length;
    const perpendicularY = vectorX / length;

    // Calculate the control point by adding the fraction of the perpendicular vector to the midpoint
    const controlX = midpointX + fraction * length * perpendicularX;
    const controlY = midpointY + fraction * length * perpendicularY;

    const pathData = `M${x1},${y1} Q${controlX},${controlY} ${x2},${y2}`;
    arc.setAttribute("d", pathData);
}

function updateArcs() {
    const arcs = document.querySelectorAll("path.arc");
    arcs.forEach(arcElement => updateArc(arcElement));
}

function updateArcsForNode(nodeId) {
    const connectedArcs = document.querySelectorAll(`path.arc[data-from="${nodeId}"], path.arc[data-to="${nodeId}"]`);
    connectedArcs.forEach(arcElement => updateArc(arcElement));
}

function startDrag(evt) {
    if (evt.target.closest(".draggable")) {
        selectedElement = evt.target.closest(".draggable");
        offset = getMousePosition(evt);
        transform = selectedElement.transform.baseVal.getItem(0);
        offset.x -= transform.matrix.e;
        offset.y -= transform.matrix.f;
    }
}

function getMousePosition(evt) {
    const CTM = svg.getScreenCTM();
    return {
        x: (evt.clientX - CTM.e) / CTM.a,
        y: (evt.clientY - CTM.f) / CTM.d
    };
}

svg.addEventListener("mousedown", startDrag);
svg.addEventListener("mousemove", drag);
svg.addEventListener("mouseup", endDrag);

function drag(evt) {
    if (selectedElement) {
        evt.preventDefault();
        const coord = getMousePosition(evt);
        transform.setTranslate(coord.x - offset.x, coord.y - offset.y);
        updateArcsForNode(selectedElement.id);
    }
}

function endDrag(evt) {
    selectedElement = null;
}

updateArcs();

function setSvgViewBox() {
    svg.setAttribute('width', window.innerWidth);
    svg.setAttribute('height', window.innerHeight);
    svg.setAttribute('viewBox', `0 0 ${window.innerWidth} ${window.innerHeight}`);
}

window.addEventListener('resize', setSvgViewBox);
setSvgViewBox(); // Set initial viewBox size
</script>
</body>
</html>
