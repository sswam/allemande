This is an important chunk of code. I want to prove that the refactored version is functionally identical to the original version. Let's break the algorithm into numbered steps, and show a markdown table with the code from each version for each step, a SAME/UNSURE/DIFFERENT column, and an explanation of why it is functionally the same / different or you are unsure. We can include higher level structure with abbreviated contents '...' to cover high-level structure too.
