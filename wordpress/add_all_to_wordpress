#!/bin/bash -eu
# add all output.md to wordpress

t=post
m=

. opts

item_type=$t
media=$m

if [ -n "$media" ]; then
	media_opts="--media $media"
else
	media_opts=
fi

for D; do
	D=$(basename "$D")

	if [ -L "$D" ]; then
		echo >&2 "___ SKIPPING SYMLINK $D"
		continue
	fi

	if [ ! -s "$D/output.1.md" ] || [ ! -s "$D/output.2.md" ]; then
		echo >&2 "___ SKIPPING BUILD $D"
		continue
	fi

	echo "*** PROCESSING $D"

	ln -sf "$D/output.1.md" "$D.md"
	ln -sf "$D/output.2.md" "$D.meta"
	v ./prettify.py -a "$D, South Gippland, Victoria" -t template/tourism.txt -c "$D.md" -m "$D.meta" > "$D.wordpress"
done

mkdir -p DONE

for D; do
	D=$(basename "$D")

	if [ -L "$D" ]; then
		echo >&2 "___ SKIPPING SYMLINK $D"
		continue
	fi

	if [ ! -s "$D/output.1.md" ] || [ ! -s "$D/output.2.md" ]; then
		echo >&2 "___ SKIPPING PUSH $D"
		continue
	fi

	echo "*** PUSHING TO WORDPRESS $D"

	v ./injectify.py --auto --$item_type --title "$D" --file "$D.wordpress" $media_opts

	if [ ! -L "$D" -a ! -e "DONE/$D" ]; then
		mvlnback "$D" "DONE/"
	fi
done
