#!/bin/bash -eu
# add all output.md to wordpress

PARALLEL_MAX=10
t=post	# post or page
T=template/tourism.txt	# template
m=1347	# which image to use

. opts

item_type=$t
template=$T
media=$m

if [ -n "$media" ]; then
	media_opts="--media $media"
else
	media_opts=
fi

check_skip() {
	local D=$1
	if [ -s "$D/wordpress.txt" ]; then
		echo >&2 "___ SKIPPING FINISHED $D"
		return 0
	fi
	if [ ! -s "$D/output.1.md" ] || [ ! -s "$D/output.2.md" ]; then
		echo >&2 "___ SKIPPING BUILD $D"
		return 0
	fi
	return 1
}

for D; do
	N=$(basename "$D")

	if check_skip "$D"; then
		continue
	fi

	echo "*** PROCESSING $N"

#	ln -sf "$D/output.1.md" "$D.md"
#	ln -sf "$D/output.2.md" "$D.meta"
	v prettify.py -a "$N, South Gippland, Victoria" -t "$template" "$D/output.1.md" "$D/output.2.md" "$D/youtube.md" > "$D/wordpress.txt"
done

mkdir -p DONE

for D; do
	N=$(basename "$D")
#	S=`slugify "$N"`

#	if check_skip "$D"; then
#		continue
#	fi

	echo "*** PUSHING TO WORDPRESS $D"

	. parallel v injectify.py --auto --$item_type --title "$N" --file "$D/wordpress.txt" $media_opts
#	. parallel v injectify.py --auto --$item_type --title "$N" --slug "$S" --file "$D/wordpress.txt" $media_opts
done
wait
